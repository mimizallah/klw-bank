(this["webpackJsonpklw-bank"]=this["webpackJsonpklw-bank"]||[]).push([[322],{1778:function(e,t,r){"use strict";r.r(t),r.d(t,"createConnection",(function(){return W}));var n=r(92),a=r(4),o=r(12),s=r(1),c=r(89),i=r(88),u=r(90),l=r(91),f=r(94),h=(r(119),r(129)),d=r(101),b=r(102),v=r(110),p=r(128),g=(r(96),r(98),r(93),r(95)),y=r(107),k=r(106),O=r(97),_=r(536),w=function(e){Object(u.a)(r,e);var t=Object(l.a)(r);function r(){return Object(c.a)(this,r),t.apply(this,arguments)}return Object(i.a)(r,[{key:"destroy",value:function(){this.emit("destroy")}},{key:"connectionError",get:function(){return this.errorString?new d.a("stream-connection",this.errorString):null}},{key:"onFeature",value:function(e){this.emit("data-received",e)}},{key:"onMessage",value:function(e){this.emit("message-received",e)}}]),r}(r(193).a.EventedAccessor);Object(f.a)([Object(O.b)({readOnly:!0})],w.prototype,"connectionError",null);var j,m,S=w=Object(f.a)([Object(g.a)("esri.layers.support.StreamConnection")],w);(m=j||(j={}))[m.CONNECTING=0]="CONNECTING",m[m.OPEN=1]="OPEN",m[m.CLOSING=2]="CLOSING",m[m.CLOSED=3]="CLOSED";var x=function(e){Object(u.a)(r,e);var t=Object(l.a)(r);function r(e){var n;Object(c.a)(this,r),(n=t.call(this))._outstandingMessages=[],n.errorString=null;var a=e.geometryType,o=e.spatialReference,s=e.sourceSpatialReference;return n._config=e,n._featureZScaler=Object(_.a)(a,s,o),n._open(),n}return Object(i.a)(r,[{key:"_open",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(){return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(y.a)(Object(k.a)(r.prototype),"destroy",this).call(this),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case j.CONNECTING:case j.OPEN:return"connected";case j.CLOSING:case j.CLOSED:return"disconnected"}}},{key:"sendMessageToSocket",value:function(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}},{key:"sendMessageToClient",value:function(e){this._onMessage(e)}},{key:"updateCustomParameters",value:function(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}},{key:"_tryCreateWebSocket",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(){var t,r,n,o,s,c,i=arguments;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=i.length>0&&void 0!==i[0]?i[0]:this._config.source.path,r=i.length>1&&void 0!==i[1]?i[1]:1e3,n=i.length>2&&void 0!==i[2]?i[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return s=Object(p.e)(t,null!==(o=this._config.customParameters)&&void 0!==o?o:{}),e.next=9,this._createWebSocket(s);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),c=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(b.a.getLogger(this).error(new d.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return b.a.getLogger(this).error(new d.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(c,"s"),e.t0)),e.next=23,Object(v.a)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_setWebSocketJSONParseHandler",value:function(e){var t=this;e.onmessage=function(e){try{var r=JSON.parse(e.data);t._onMessage(r)}catch(n){return void b.a.getLogger(t).error(new d.a("websocket-connection","Failed to parse message, invalid JSON",{error:n}))}}}},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var a=new WebSocket(e);a.onopen=function(){if(a.onopen=null,t.destroyed)return a.onclose=null,void a.close();a.onclose=function(e){return t._onClose(e)},a.onerror=function(e){return t._onError(e)},t._setWebSocketJSONParseHandler(a),r(a)},a.onclose=function(e){a.onopen=a.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(){var t,r,o,s,c,i,u,l,f=this,h=arguments;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,null!=(r=this._websocket)){e.next=4;break}return e.abrupt("return");case 4:return o=Object(v.c)(),s=r.onmessage,c=this._config,i=c.filter,u=c.outFields,l=c.spatialReference,e.abrupt("return",(o.timeout(t),r.onmessage=function(e){var t,a=null;try{a=JSON.parse(e.data)}catch(p){}a&&"object"==typeof a||(b.a.getLogger(f).error(new d.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),o.reject(),f.destroy()),(null===(t=a.spatialReference)||void 0===t?void 0:t.wkid)!==(null===l||void 0===l?void 0:l.wkid)&&(b.a.getLogger(f).error(new d.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(l.wkid),e.data)),o.reject(),f.destroy()),"json"!==a.format&&(b.a.getLogger(f).error(new d.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),o.reject(),f.destroy()),i&&a.filter!==i&&b.a.getLogger(f).error(new d.a("websocket-connection","Tried to set filter, but server doesn't support it")),u&&a.outFields!==u&&b.a.getLogger(f).error(new d.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=s;var c,h=Object(n.a)(f._outstandingMessages);try{for(h.s();!(c=h.n()).done;){var v=c.value;r.send(JSON.stringify(v))}}catch(g){h.e(g)}finally{h.f()}f._outstandingMessages=[],o.resolve()},r.send(JSON.stringify({filter:i,outFields:u,format:"json",spatialReference:{wkid:l.wkid}})),o.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":var t,r=Object(n.a)(e.features);try{for(r.s();!(t=r.n()).done;){var a=t.value;null!=this._featureZScaler&&this._featureZScaler(a.geometry),this.onFeature(a)}}catch(o){r.e(o)}finally{r.f()}}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),b.a.getLogger(this).error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&b.a.getLogger(this).error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(S);Object(f.a)([Object(O.b)()],x.prototype,"connectionStatus",null),Object(f.a)([Object(O.b)()],x.prototype,"errorString",void 0),x=Object(f.a)([Object(g.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],x);var F=r(408),C=r(210),R=r(122),N=r(125),L={maxQueryDepth:5,maxRecordCountFactor:3},E=function(e){Object(u.a)(f,e);var t=Object(l.a)(f);function f(e){var r;return Object(c.a)(this,f),(r=t.call(this,Object(s.a)(Object(s.a)({},L),e)))._buddyServicesQuery=null,r._relatedFeatures=null,r}return Object(i.a)(f,[{key:"_open",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(){var t,r,n,o,s;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||b.a.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,o=n.filter,s=n.outFields,this.destroyed||this._setFilter(o,s);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){if("attributes"in e){var t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void b.a.getLogger(this).error(new d.a("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}else this.onMessage(e)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t){var r,n,o;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(s.a)({f:"json"},this._config.customParameters),n=Object(h.default)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return o=e.sent.data,e.abrupt("return",(this._serviceDefinition=o,o));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,a=r.token,o=this._inferWebSocketBaseUrl(n);return Object(p.e)("".concat(o,"/subscribe"),{outSR:""+t.wkid,token:a})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.includes("wss"))return a}}catch(o){r.e(o)}finally{r.f()}return b.a.getLogger(this).error(new d.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t,r){var n,o,s,c,i,u,l=this;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(n=this._websocket)&&(null!=t||null!=r)){e.next=3;break}return e.abrupt("return");case 3:return o=JSON.stringify({filter:this._serializeFilter(t,r)}),s=!1,c=Object(v.c)(),i=function(){s||(l.destroyed||l._websocket!==n||b.a.getLogger(l).error(new d.a("geoevent-connection","Server timed out when setting filter")),c.reject())},u=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(b.a.getLogger(l).error(new d.a("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),c.reject(t.error)),l._setWebSocketJSONParseHandler(n),s=!0,c.resolve())},e.abrupt("return",(n.onmessage=u,n.send(o),setTimeout(i,1e4),c.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(null==e&&null==t)return r;if(null!=e&&e.geometry)try{var n=Object(R.a)(e.geometry);if("extent"!==n.type)throw new d.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(a){b.a.getLogger(this).error(new d.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",a))}return null!=e&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(r.where=e.where),null!=t&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t],n=this._relatedFeatures.get(r);if(!n)return b.a.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var a=n.attributes,o=n.geometry;for(var s in a)e.attributes[s]=a[s];return o&&(e.geometry=o),e.geometry||e.centroid||b.a.getLogger(this).error(new d.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(){var t,r,o,s,c,i,u,l,f;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,o=t.keepLatestArchive,s=this._queryRelatedFeatures(r),c=this._queryArchive(o),e.next=4,s;case 4:return e.next=6,c;case 6:if(i=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=Object(n.a)(i.features);try{for(u.s();!(l=u.n()).done;)f=l.value,this.onFeature(this._enrich(f))}catch(a){u.e(a)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),b.a.getLogger(this).error(new d.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t){var r;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t){return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t){var n,o,s,c,i,u,l,f,h,d,b,v,p,g;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,412));case 2:return e.t0=e.sent.default,e.t1={url:t},c=new e.t0(e.t1),e.next=7,c.load();case 7:if(i=e.sent,u=i.capabilities,l=u.query.supportsMaxRecordCountFactor,f=u.query.supportsPagination,h=u.query.supportsCentroid,d=this._config.maxRecordCountFactor,b=c.capabilities.query.maxRecordCount,v=l?b*d:b,(p=new C.a).outFields=null!==(n=this._config.outFields)&&void 0!==n?n:["*"],p.where=null!==(o=null===(s=this._config.filter)||void 0===s?void 0:s.where)&&void 0!==o?o:"1=1",p.returnGeometry=!0,p.returnExceededLimitFeatures=!0,p.outSpatialReference=N.a.fromJSON(this._config.spatialReference),h&&(p.returnCentroid=!0),l&&(p.maxRecordCountFactor=d),!f){e.next=18;break}return e.abrupt("return",(p.num=v,c.destroy(),this._queryPages(t,p)));case 18:return e.next=20,Object(F.a)(t,p,this._config.sourceSpatialReference);case 20:return g=e.sent,e.abrupt("return",(c.destroy(),g.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(o.a)(Object(a.a)().mark((function e(t,r){var n,o,s,c,i,u=arguments;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=u.length>2&&void 0!==u[2]?u[2]:[],s=u.length>3&&void 0!==u[3]?u[3]:0,r.start=null!=r.num?s*r.num:null,e.next=5,Object(F.a)(t,r,this._config.sourceSpatialReference);case 5:return c=e.sent,i=c.data,e.abrupt("return",i.exceededTransferLimit&&s<(null!==(n=this._config.maxQueryDepth)&&void 0!==n?n:0)?(i.features.forEach((function(e){return o.push(e)})),this._queryPages(t,r,o,s+1)):(o.forEach((function(e){return i.features.push(e)})),i));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,a=e.features,o=this._serviceDefinition.relatedFeatures.joinField,s=Object(n.a)(a);try{for(s.s();!(t=s.n()).done;){var c=t.value,i=c.attributes[o];r.set(i,c)}}catch(u){s.e(u)}finally{s.f()}this._relatedFeatures=r}}]),f}(x),P=E=Object(f.a)([Object(g.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],E),M=function(e){Object(u.a)(r,e);var t=Object(l.a)(r);function r(e){var n;Object(c.a)(this,r),(n=t.call(this)).connectionStatus="connected",n.errorString=null;var a=e.geometryType,o=e.spatialReference,s=e.sourceSpatialReference;return n._featureZScaler=Object(_.a)(a,s,o),n}return Object(i.a)(r,[{key:"updateCustomParameters",value:function(e){}},{key:"sendMessageToSocket",value:function(e){}},{key:"sendMessageToClient",value:function(e){if("type"in e)switch(e.type){case"features":case"featureResult":var t,r=Object(n.a)(e.features);try{for(r.s();!(t=r.n()).done;){var a=t.value;null!=this._featureZScaler&&this._featureZScaler(a.geometry),this.onFeature(a)}}catch(o){r.e(o)}finally{r.f()}}this.onMessage(e)}}]),r}(S);function W(e,t,r,n,a,o,s,c){var i={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:a,maxReconnectionAttempts:o,maxReconnectionInterval:s,customParameters:c};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new x(i):new P(i):new M(i)}Object(f.a)([Object(O.b)()],M.prototype,"connectionStatus",void 0),Object(f.a)([Object(O.b)()],M.prototype,"errorString",void 0),M=Object(f.a)([Object(g.a)("esri.layers.support.ClientSideConnection")],M)}}]);
//# sourceMappingURL=322.ea7db515.chunk.js.map