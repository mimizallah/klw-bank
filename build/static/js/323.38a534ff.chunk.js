(this["webpackJsonpklw-bank"]=this["webpackJsonpklw-bank"]||[]).push([[323],{2280:function(e,t,r){"use strict";r.r(t),r.d(t,"uploadAssets",(function(){return x}));var n=r(4),a=r(92),s=r(12),c=r(129),o=r(101),u=r(102),p=r(110),i=r(128),l=r(564),f=r(1031),b=r(324),d=1e6,h=20*d,j=2e9,y=3;function O(e,t,r){return m.apply(this,arguments)}function m(){return m=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var o,u,l,f,O,m,w,x,v,k,g,T,D,E,F,U,A,N,S,I,q,P,R,C,L,B,J,z;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.data,u=t.name,l=t.description,f=null,e.prev=2,O=Object(i.D)(r,"uploads"),m=Object(i.D)(O,"info"),e.next=7,Object(c.default)(m,{query:{f:"json"},responseType:"json"});case 7:if(w=e.sent,x=w.data,Object(p.n)(a),v=Object(b.c)(r),k=x.maxUploadFileSize*d,g=v?j:k,T=v?Math.min(h,k):h,!(o.size>g)){e.next=13;break}throw new Error("Data too large");case 13:return D=Object(i.D)(O,"register"),e.next=16,Object(c.default)(D,{query:{f:"json",itemName:u,description:l},responseType:"json",method:"post"});case 16:if(E=e.sent,F=E.data,Object(p.n)(a),F.success){e.next=20;break}throw new Error("Registration failed");case 20:for(U=F.item.itemID,f=Object(i.D)(O,U),A=Object(i.D)(f,"uploadPart"),N=Math.ceil(o.size/T),S=new Array,I=0;I<N;++I)S.push(o.slice(I*T,Math.min((I+1)*T,o.size)));for(q=S.slice().reverse(),P=new Array,R=function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,r,s,o,u;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===q.length){e.next=11;break}return t=S.length-q.length,r=q.pop(),(s=new FormData).append("f","json"),s.append("file",r),s.append("partId","".concat(t)),e.next=5,Object(c.default)(A,{timeout:0,body:s,responseType:"json",method:"post"});case 5:if(o=e.sent,u=o.data,Object(p.n)(a),u.success){e.next=9;break}throw new Error("Part upload failed");case 9:e.next=0;break;case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),C=0;C<y&&0!==q.length;++C)P.push(R());return e.next=28,Promise.all(P);case 28:return L=Object(i.D)(f,"commit"),e.next=31,Object(c.default)(L,{query:{f:"json",parts:S.map((function(e,t){return t})).join(",")},responseType:"json",method:"post"});case 31:if(B=e.sent,J=B.data,Object(p.n)(a),J.success){e.next=35;break}throw new Error("Commit failed");case 35:return e.abrupt("return",J.item);case 38:if(e.prev=38,e.t0=e.catch(2),null==f){e.next=44;break}return z=Object(i.D)(f,"delete"),e.next=44,Object(c.default)(z,{query:{f:"json"},responseType:"json",method:"post"});case 44:throw e.t0;case 45:case"end":return e.stop()}}),e,null,[[2,38]])}))),m.apply(this,arguments)}var w=r(538);function x(e,t,r){return v.apply(this,arguments)}function v(){return(v=Object(s.a)(Object(n.a)().mark((function e(t,r,a){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.length?Promise.all(t.map((function(e){return k(e,r,a)}))):[]);case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e,t,r){return g.apply(this,arguments)}function g(){return(g=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,c,u,p;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.layer,c=r.ongoingUploads,!(u=c.get(t))){e.next=4;break}return e.abrupt("return",u);case 4:if(ee(s)){e.next=6;break}throw new o.a("".concat(s.type,"-layer:upload-failure"),"Layer does not support asset uploads.",new Error);case 6:if(!T(t,s)){e.next=8;break}return e.abrupt("return",t);case 8:return p=D(t,s,a),c.set(t,p),e.prev=10,e.next=13,p;case 13:return e.prev=13,c.delete(t),e.finish(13);case 16:return e.abrupt("return",t);case 17:case"end":return e.stop()}}),e,null,[[10,,13,16]])})))).apply(this,arguments)}function T(e,t){var r=t.parsedUrl;return null!=r&&e.metadata.externalSources.some((function(e){return Object(f.d)(e,r)}))}function D(e,t,r){return E.apply(this,arguments)}function E(){return(E=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,c,o,u,i,l,f;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.metadata,c=s.displaySource,o=C(null===c||void 0===c?void 0:c.source,r),u=!!o,i=s.externalSources.length>0,l=u?F(o,r,a):i?A(t,r,a):S(t,r,a),e.next=8,l;case 8:return f=e.sent,e.abrupt("return",(Object(p.n)(a),t.addExternalSources([f]),t));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(e,t,r){return U.apply(this,arguments)}function U(){return(U=Object(s.a)(Object(n.a)().mark((function e(t,r,a){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,B(t,r,a);case 2:return e.t0=e.sent,e.t1=!0,e.abrupt("return",{source:e.t0,original:e.t1});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e,t,r){return N.apply(this,arguments)}function N(){return(N=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,c,u,p;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=te(r),c=t.metadata.externalSources,u=R(c,r)){e.next=3;break}throw new o.a("".concat(r.type,"-layer:upload-failure"),"Could not find an external source that is supported by the service.",new Error);case 3:return e.next=5,B(u,r,a);case 5:return p=e.sent,t.addExternalSources([{source:p,original:!0}]),e.next=9,Y(p,r,s);case 9:return e.t0=e.sent,e.abrupt("return",{source:e.t0});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S(e,t,r){return I.apply(this,arguments)}function I(){return(I=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=q(t,r,a),e.next=3,z([s],r,a);case 3:return e.t0=e.sent,e.t1=t.extent.clone(),e.t2=!0,e.abrupt("return",{source:e.t0,extent:e.t1,original:e.t2});case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function q(e,t,r){return P.apply(this,arguments)}function P(){return(P=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,c,o,u;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=te(r),e.next=3,t.load(a);case 3:return c=e.sent,e.next=6,c.toBinaryGLTF({ignoreLocalTransform:!0});case 6:return o=e.sent,Object(p.n)(a),e.next=10,o.buffer();case 10:return u=e.sent,e.abrupt("return",(Object(p.n)(a),{blob:new Blob([u.data],{type:u.type}),assetName:"".concat(Object(l.a)(),".glb"),assetType:s}));case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e,t){var r,n=Object(a.a)(e);try{for(n.s();!(r=n.n()).done;){var s=C(r.value.source,t);if(s)return s}}catch(c){n.e(c)}finally{n.f()}return null}function C(e,t){if(!e)return null;for(var r=t.infoFor3D,n=r.supportedFormats,a=r.editFormats,s=Object(f.e)(e),c=new Array,o=!1,u=0;u<s.length;++u){var p=L(s[u],n);if(!p)return null;a.includes(p.assetType)&&(o=!0),c.push(p)}return o?c:null}function L(e,t){var r=Object(f.c)(e,t);return r?{asset:e,assetType:r}:null}function B(e,t,r){return J.apply(this,arguments)}function J(){return(J=Object(s.a)(Object(n.a)().mark((function e(t,r,a){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",z(t.map((function(e){return M(e,a)})),r,a));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function z(e,t,r){return H.apply(this,arguments)}function H(){return H=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var c,o,u;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(t.map(function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var s;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=W,e.next=3,t;case 3:return e.t1=e.sent,e.t2=r,e.t3=a,s=(0,e.t0)(e.t1,e.t2,e.t3),e.abrupt("return",(Object(p.n)(a),s));case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:return c=e.sent,Object(p.n)(a),e.next=6,Q(c.map((function(e){return e.item})),r,a);case 6:return o=e.sent,u=o.uploadResults,e.abrupt("return",(Object(p.n)(a),t.map((function(e,t){return X(c[t],u[t],r)}))));case 9:case"end":return e.stop()}}),e)}))),H.apply(this,arguments)}function M(e,t){return G.apply(this,arguments)}function G(){return(G=Object(s.a)(Object(n.a)().mark((function e(t,r){var a,s,c;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.asset,s=t.assetType,!(a instanceof File)){e.next=3;break}return e.abrupt("return",{blob:a,assetName:a.name,assetType:s});case 3:return e.next=5,a.toBlob(r);case 5:return c=e.sent,e.abrupt("return",(Object(p.n)(r),{blob:c,assetName:a.assetName,assetType:s}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function W(e,t,r){return K.apply(this,arguments)}function K(){return(K=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,c,l,f,b,d;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.blob,c=t.assetType,l=t.assetName,f=null,e.prev=2,e.next=5,O({data:s,name:l},r.url,a);case 5:b=e.sent,Object(p.n)(a),f={assetType:c,assetUploadId:b.itemID},e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),Object(p.m)(e.t0),u.a.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce("Service ".concat(r.url," does not support the REST Uploads API."));case 12:if(f){e.next=19;break}return e.next=15,Object(i.J)(s);case 15:if(d=e.sent,Object(p.n)(a),d.isBase64){e.next=18;break}throw new o.a("".concat(r.type,"-layer:uploadAssets-failure"),"Expected gltf data in base64 format after conversion.",new Error);case 18:f={assetType:c,assetData:d.data};case 19:if(f){e.next=21;break}throw new o.a("".concat(r.type,"-layer:uploadAssets-failure"),"Unable to prepare uploadAsset request options.",new Error);case 21:return e.abrupt("return",{item:f,assetName:l});case 22:case"end":return e.stop()}}),e,null,[[2,9]])})))).apply(this,arguments)}function Q(e,t,r){return V.apply(this,arguments)}function V(){return(V=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.default)(Object(i.D)(r.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(t)},method:"post",responseType:"json"});case 2:if(s=e.sent,Object(p.n)(a),s.data.uploadResults.length===t.length){e.next=5;break}throw new o.a("".concat(r.type,"-layer:uploadAssets-failure"),"Bad response. Uploaded ".concat(t.length," items and received ").concat(s.data.uploadResults.length," results."),new Error);case 5:return e.abrupt("return",s.data);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(e,t,r){if(!t.success){var n=t.error;throw new o.a("".concat(r.type,"-layer:upload-failure"),"Failed to upload mesh file ".concat(e.assetName,". Error code: ").concat(n.code,". Error message: ").concat(n.messages),new Error)}var a=t.assetHash,s=e.assetName,c=e.item.assetType,u=r.infoFor3D.supportedFormats,p=Object(w.c)(c,u);if(!p)throw new o.a("".concat(r.type,"-layer:upload-failure"),"The service allowed us to upload an asset of FormatID ".concat(c,", but it does not list it in its supported formats."),new Error);return new f.a(s,p,[new f.b("".concat(r.parsedUrl.path,"/assets/").concat(a),a)])}function Y(e,t,r){return Z.apply(this,arguments)}function Z(){return(Z=Object(s.a)(Object(n.a)().mark((function e(t,r,a){var s,u,p,l,b,d,h;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=t.map((function(e){return{assetName:e.assetName,assetHash:e.parts[0].partHash}})),p=null===(s=r.capabilities)||void 0===s?void 0:s.operations.supportsAsyncConvert3D,l={query:{f:"json",assets:JSON.stringify(u),transportType:"esriTransportTypeUrl",targetFormat:a,async:p},responseType:"json",timeout:0},b=Object(i.D)(r.parsedUrl.path,"convert3D"),!p){e.next=10;break}return e.next=7,$(b,l);case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,Object(c.default)(b,l);case 12:e.t0=e.sent;case 13:return d=e.t0.data,h=r.infoFor3D.supportedFormats,e.abrupt("return",d.assets.map((function(e){var t=Object(w.d)(e.contentType,h);if(!t)throw new o.a("".concat(r.type,"-layer:upload-failure"),"The service allowed us to upload an asset of FormatID ".concat(t,", but it does not list it in its supported formats."),new Error);return new f.a(e.assetName,e.contentType,[new f.b(e.assetURL,e.assetHash)])})));case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $(e,t){return _.apply(this,arguments)}function _(){return(_=Object(s.a)(Object(n.a)().mark((function e(t,r){var a,s;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.default)(t,r);case 2:a=e.sent.data.statusUrl;case 3:return e.next=5,Object(c.default)(a,{query:{f:"json"},responseType:"json"});case 5:s=e.sent.data,e.t0=s.status,e.next="Completed"===e.t0?9:"CompletedWithErrors"===e.t0?10:"Failed ImportChanges"===e.t0||"InProgress"===e.t0||"Pending"===e.t0||"ExportAttachments"===e.t0||"ExportChanges"===e.t0||"ExportingData"===e.t0||"ExportingSnapshot"===e.t0||"ImportAttachments"===e.t0||"ProvisioningReplica"===e.t0||"UnRegisteringReplica"===e.t0?11:12;break;case 9:return e.abrupt("return",Object(c.default)(s.resultUrl,{query:{f:"json"},responseType:"json"}));case 10:throw new o.a("async-convert3D-failed","asynchronous convert3D call failed.");case 11:return e.abrupt("break",13);case 12:throw new o.a("async-convert3D-failed","asynchronous convert3D call failed (undefined response status)");case 13:return e.next=15,Object(p.a)(re);case 15:e.next=3;break;case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ee(e){return!!e.infoFor3D&&!!e.url}function te(e){var t,r=e.infoFor3D,n=null!==(t=Object(w.d)("model/gltf-binary",r.supportedFormats))&&void 0!==t?t:Object(w.b)("glb",r.supportedFormats);if(!n)throw new o.a("".concat(e.type,"-layer:upload-failure"),"Layer does not support glb.",new Error);return n}var re=1e3}}]);
//# sourceMappingURL=323.38a534ff.chunk.js.map